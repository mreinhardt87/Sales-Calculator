<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Sales Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .deal-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .checkbox-label:hover {
            background-color: #f9fafb;
        }
        input[type="checkbox"]:checked + .checkbox-label {
             border-color: #3b82f6;
             background-color: #eff6ff;
        }
        input[type="checkbox"]:disabled + .checkbox-label {
            cursor: not-allowed;
            background-color: #f9fafb;
            color: #9ca3af;
        }
        input[type="checkbox"] {
            display: none;
        }
        .checkmark {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #9ca3af;
            border-radius: 0.25rem;
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        input[type="checkbox"]:checked + .checkbox-label .checkmark {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        input[type="checkbox"]:disabled + .checkbox-label .checkmark {
            background-color: #e5e7eb;
            border-color: #d1d5db;
        }
        .checkmark svg {
            display: none;
        }
        input[type="checkbox"]:checked + .checkbox-label .checkmark svg {
            display: block;
        }
        .red-hot-ticket {
            border-color: #ef4444;
            background-image: linear-gradient(to right, #fef2f2, #fff1f2);
        }
        /* Stop browsers from adding spinners to number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Login Screen -->
    <div id="login-screen" class="max-w-md w-full">
        <div class="deal-card bg-white rounded-xl overflow-hidden">
            <div class="p-6 bg-gray-800 text-white text-center">
                <h1 class="text-2xl font-bold">Sales Calculator Access</h1>
            </div>
            <div class="p-6">
                <form id="login-form">
                    <div class="mb-4">
                        <label for="passcode" class="block text-sm font-medium text-gray-700">Passcode</label>
                        <input type="password" id="passcode" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <button type="submit" class="w-full p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Login
                    </button>
                    <p id="login-error" class="text-red-500 text-sm text-center mt-2 hidden">Invalid Passcode.</p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Calculator (Hidden by default) -->
    <div id="calculator-container" class="max-w-4xl w-full grid-cols-1 md:grid-cols-2 gap-8 hidden">
        <div class="max-w-md w-full mx-auto">
            <!-- Main Deal Card -->
            <div class="deal-card bg-white rounded-xl overflow-hidden">
                <!-- Header Section -->
                <div class="p-6 bg-gray-800 text-white text-center">
                    <h1 id="header-title" class="text-2xl font-bold">Sales Calculator</h1>
                    <p id="header-subtitle" class="font-semibold mt-1">Configure your transaction below</p>
                </div>

                <!-- Cost Breakdown Section -->
                <div class="p-6">
                    <!-- Controls Section -->
                    <div class="mb-4">
                         <div>
                            <label for="upgrade-type-select" class="block text-sm font-medium text-gray-700 mb-1">Select Transaction Type:</label>
                            <select id="upgrade-type-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="updateCalculator()">
                                <option value="" selected>-- Select an Option --</option>
                                <option value="new-account">New account</option>
                                <option value="add-a-line">Add a line</option>
                                <option value="upgrade-only">Upgrade Only</option>
                                <option value="upgrade-with-rewards">Upgrade with Rewards</option>
                                <option value="upgrade-add-line">Upgrade & add a line</option>
                            </select>
                        </div>
                    </div>
                    <!-- [NEW] Rewards Dropdown -->
                    <div id="rewards-container" class="mb-4 hidden">
                        <label for="rewards-select" class="block text-sm font-medium text-gray-700 mb-1">Select Reward Amount:</label>
                        <select id="rewards-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="updateCalculator()">
                            <option value="0" selected>-- Select Reward --</option>
                            <option value="100">$100</option>
                            <option value="200">$200</option>
                            <option value="300">$300</option>
                            <option value="400">$400</option>
                        </select>
                    </div>
                    <div class="mb-4">
                         <div>
                            <label for="plan-select" id="plan-select-label" class="block text-sm font-medium text-gray-700 mb-1">Select Plan:</label>
                            <select id="plan-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" onchange="updateCalculator()">
                                <option value="" selected>-- Select a Plan --</option>
                                <option value="40">Base 5G - $40 Plan</option>
                                <option value="50">Total 5G - $50 Plan</option>
                                <option value="60">Total 5G+ - $60 Plan</option>
                            </select>
                        </div>
                    </div>
                    <!-- [NEW] Add a Line Controls -->
                     <div id="add-a-line-controls" class="hidden space-y-4 mb-4">
                        <div>
                            <label for="current-lines-select" class="block text-sm font-medium text-gray-700 mb-1">Current Number of Lines:</label>
                            <select id="current-lines-select" class="w-full p-2 border border-gray-300 rounded-md" onchange="updateCalculator()">
                                <option value="0">-- Select --</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div id="billing-cycle-container" class="hidden">
                            <label for="billing-cycle-days" class="block text-sm font-medium text-gray-700 mb-1">Days into Billing Cycle:</label>
                            <input type="number" id="billing-cycle-days" class="w-full p-2 border border-gray-300 rounded-md" min="0" max="30" value="0" oninput="updateCalculator()">
                        </div>
                    </div>

                    <!-- Universal Device Count -->
                     <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="byod-lines" class="block text-sm font-medium text-gray-700">BYOD Lines:</label>
                            <select id="byod-lines" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="updateLineDropdowns('byod')">
                                <!-- Options dynamically populated -->
                            </select>
                        </div>
                        <div>
                            <label for="new-device-lines" class="block text-sm font-medium text-gray-700">New Device Lines:</label>
                            <select id="new-device-lines" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="updateLineDropdowns('new')">
                                <!-- Options dynamically populated -->
                            </select>
                        </div>
                    </div>
                    <div id="new-device-selectors" class="space-y-2 mb-4"></div>
                    <!-- [NEW] Upgrade Device Lines Dropdown -->
                     <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="upgrade-device-lines" class="block text-sm font-medium text-gray-700">Upgrade Device Lines:</label>
                            <select id="upgrade-device-lines" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="generateUpgradeDeviceSelectors()">
                                <!-- Options dynamically populated -->
                            </select>
                        </div>
                        <div>
                            <label for="protect-lines" class="block text-sm font-medium text-gray-700">Total Protect Lines:</label>
                            <select id="protect-lines" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="updateCalculator()">
                                <!-- Options dynamically populated -->
                            </select>
                        </div>
                    </div>
                    <div id="upgrade-device-selectors" class="space-y-2 mb-4"></div>
                     <div class="mb-4">
                        <label for="accessory-bundles" class="block text-sm font-medium text-gray-700">Accessory Bundles: (Case, Glass Protector & Wall Charger)</label>
                        <select id="accessory-bundles" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="updateCalculator()">
                            <!-- Options dynamically populated -->
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="tablet-select" class="block text-sm font-medium text-gray-700">Add Tablet:</label>
                            <select id="tablet-select" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="updateCalculator()">
                                <!-- Options dynamically populated -->
                            </select>
                        </div>
                        <div>
                            <label for="byot-lines" class="block text-sm font-medium text-gray-700">Bring Your Own Tablet:</label>
                            <select id="byot-tablet-lines" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="updateCalculator()">
                                <!-- Options dynamically populated -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Port-in and ID Validation Checkboxes -->
                    <div class="mb-4 space-y-2">
                        <div>
                            <input type="checkbox" id="id-verified" onchange="updateCalculator()">
                            <label for="id-verified" class="checkbox-label text-sm py-2">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span>ID Verified (Veriff)</span>
                            </label>
                        </div>
                         <div>
                            <input type="checkbox" id="port-in" onchange="updateCalculator()">
                            <label for="port-in" class="checkbox-label text-sm py-2">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span>External Port-in</span>
                            </label>
                        </div>
                        <div id="ported-lines-container" class="hidden ml-8 space-y-2">
                            <div>
                                <label for="ported-lines" class="block text-sm font-medium text-gray-700">Total Ported Lines:</label>
                                <select id="ported-lines" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="updateCalculator()">
                                    <!-- Options dynamically populated -->
                                </select>
                            </div>
                             <div id="byod-ports-container" class="hidden">
                                <label for="byod-ports-select" class="block text-sm font-medium text-gray-700">Number of BYOD Ports:</label>
                                <select id="byod-ports-select" class="mt-1 w-full p-2 border border-gray-300 rounded-md" onchange="updateCalculator()">
                                    <!-- Options dynamically populated -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Promo Box -->
                    <div id="promo-box" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p id="promo-box-text" class="text-sm text-blue-800"></p>
                    </div>

                    <!-- Interactive "Due Today" Section -->
                    <h2 class="text-lg font-semibold text-gray-700 mb-4 border-t pt-4">Calculate Amount Due Today:</h2>
                    <div class="space-y-3">
                        <!-- Device Cost (hidden by default) -->
                        <div id="device-cost-container" class="hidden">
                            <input type="checkbox" id="device-cost" data-amount="0" disabled>
                            <label for="device-cost" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="device-cost-label" class="flex-grow">Mobile Device Cost</span>
                                <span id="device-cost-amount" class="font-bold text-gray-800">$0.00</span>
                            </label>
                        </div>
                    
                        <!-- First Month Service Checkbox -->
                        <div id="service-container">
                            <input type="checkbox" id="service" data-amount="55" onchange="updateCalculator()">
                            <label for="service" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="service-label" class="flex-grow">First Month Mobile Service</span>
                                <span id="service-amount" class="font-bold text-gray-800">$55.00</span>
                            </label>
                        </div>

                        <!-- Total Protect Checkbox -->
                        <div id="total-protect-container">
                            <input type="checkbox" id="total-protect" data-amount="5" onchange="updateCalculator()">
                            <label for="total-protect" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="protect-label" class="flex-grow">Total Protect (Mobile)</span>
                                <span id="protect-amount" class="font-bold text-gray-800">$5.00</span>
                            </label>
                        </div>
                        
                        <!-- Accessory Bundle Cost -->
                        <div id="accessory-bundle-container" class="hidden">
                            <input type="checkbox" id="accessory-bundle-cost" data-amount="0" disabled>
                            <label for="accessory-bundle-cost" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="accessory-bundle-label" class="flex-grow">Accessory Bundle (Case, Screen protector & Wall charger)</span>
                                <span id="accessory-bundle-amount" class="font-bold text-gray-800">$0.00</span>
                            </label>
                        </div>
                        
                        <!-- Promotional Months -->
                        <div id="promo-months-container" class="hidden">
                            <input type="checkbox" id="promo-months" data-amount="0" onchange="updateCalculator()">
                            <label for="promo-months" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="promo-months-label" class="flex-grow">Promotional Months</span>
                                <span id="promo-months-amount" class="font-bold text-gray-800">$0.00</span>
                            </label>
                        </div>
                        
                        <!-- Home Internet Section -->
                        <div>
                            <input type="checkbox" id="home-internet" data-amount="49.99" onchange="updateCalculator()">
                            <label for="home-internet" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="internet-label" class="flex-grow">Home Internet Service</span>
                                <span id="internet-amount" class="font-bold text-gray-800">$49.99</span>
                            </label>
                        </div>

                         <!-- Home Router Device Cost (hidden by default) -->
                        <div id="router-cost-container" class="hidden">
                            <input type="checkbox" id="router-cost" data-amount="49.99" disabled>
                            <label for="router-cost" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="router-cost-label" class="flex-grow">Home Router Device</span>
                                <span id="router-cost-amount" class="font-bold text-gray-800">$49.99</span>
                            </label>
                        </div>
                        
                        <!-- [NEW] Dedicated Hotspot Section -->
                        <div>
                            <input type="checkbox" id="dedicated-hotspot" data-amount="49.99" onchange="updateCalculator()">
                            <label for="dedicated-hotspot" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span class="flex-grow">Dedicated Hotspot Device</span>
                                <span class="font-bold text-gray-800">$49.99</span>
                            </label>
                        </div>
                        <div id="hotspot-plan-container" class="hidden ml-8">
                             <label for="hotspot-plan-select" class="block text-sm font-medium text-gray-700 mb-1">Select Hotspot Plan:</label>
                             <select id="hotspot-plan-select" class="w-full p-2 border border-gray-300 rounded-md" onchange="updateCalculator()">
                                <option value="30">15GB - $30</option>
                                <option value="40">40GB - $40</option>
                                <option value="50">100GB - $50</option>
                            </select>
                        </div>

                        <!-- Tablet Service Cost -->
                        <div id="tablet-service-container" class="hidden">
                            <input type="checkbox" id="tablet-service" data-amount="0" disabled>
                            <label for="tablet-service" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="tablet-service-label" class="flex-grow">Tablet Service</span>
                                <span id="tablet-service-amount" class="font-bold text-gray-800">$0.00</span>
                            </label>
                        </div>
                        
                        <!-- [NEW] Tablet Device Cost -->
                        <div id="tablet-device-cost-container" class="hidden">
                            <input type="checkbox" id="tablet-device-cost" data-amount="0" disabled>
                            <label for="tablet-device-cost" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="tablet-device-cost-label" class="flex-grow">Tablet Device</span>
                                <span id="tablet-device-cost-amount" class="font-bold text-gray-800">$0.00</span>
                            </label>
                        </div>

                        <!-- BYOT Service Cost -->
                        <div id="byot-service-container" class="hidden">
                            <input type="checkbox" id="byot-service" data-amount="0" disabled>
                            <label for="byot-service" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="byot-service-label" class="flex-grow">BYOT Service (1st Month)</span>
                                <span id="byot-service-amount" class="font-bold text-gray-800">$0.00</span>
                            </label>
                        </div>

                        <!-- Access Fee Checkbox -->
                        <div id="access-fee-container">
                            <input type="checkbox" id="access" data-amount="25" onchange="updateCalculator()">
                            <label for="access" class="checkbox-label">
                                 <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="access-label" class="flex-grow">Access Fee (Mobile)</span>
                                <span id="access-amount" class="font-bold text-gray-800">$25.00</span>
                            </label>
                        </div>

                        <!-- Sim Card Fee Checkbox (hidden by default) -->
                        <div id="sim-card-container" class="hidden">
                            <input type="checkbox" id="sim-card-fee" data-amount="0" disabled>
                            <label for="sim-card-fee" class="checkbox-label">
                                 <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="sim-card-label" class="flex-grow">Sim Card</span>
                                <span id="sim-card-amount" class="font-bold text-gray-800">$0.00</span>
                            </label>
                        </div>

                        <!-- [NEW] Rewards Credit -->
                         <div id="rewards-credit-container" class="hidden">
                            <input type="checkbox" id="rewards-credit" data-amount="0" disabled>
                            <label for="rewards-credit" class="checkbox-label border-green-500 bg-green-50">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span id="rewards-credit-label" class="flex-grow text-green-700 font-medium">Rewards Credit</span>
                                <span id="rewards-credit-amount" class="font-bold text-green-700">-$0.00</span>
                            </label>
                        </div>

                        <!-- Red Hot Ticket -->
                        <div id="red-hot-ticket-container" class="hidden">
                            <input type="checkbox" id="red-hot-ticket" onchange="updateCalculator()">
                            <label for="red-hot-ticket" class="checkbox-label red-hot-ticket">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <span class="flex-grow font-bold text-red-600">Apply Red Hot Ticket! (Up to $120 off)</span>
                            </label>
                        </div>

                        <!-- Sales Tax Section -->
                        <div>
                            <input type="checkbox" id="sales-tax" checked onchange="updateCalculator()">
                            <label for="sales-tax" class="checkbox-label">
                                <span class="checkmark"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span>
                                <div class="flex-grow flex items-center" onclick="event.preventDefault()">
                                    <span>Sales Tax at</span>
                                    <input type="number" id="tax-rate-input" value="10.3" step="0.1" class="w-20 mx-2 p-1 text-center rounded border bg-white border-gray-300" oninput="updateCalculator()">
                                    <span>%</span>
                                </div>
                                <span id="tax-amount" class="font-bold text-gray-800">$28.84</span>
                            </label>
                        </div>
                    </div>

                    <!-- Total Section -->
                    <div class="mt-6 pt-4 border-t-2 border-dashed">
                        <div class="flex justify-between items-center text-xl font-bold text-gray-800">
                            <span>Total Due Today:</span>
                            <span id="total-due" class="text-blue-600">$113.84</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">This calculation is for estimation only. Today price may vary</p>
                    </div>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="reset-button" onclick="resetCalculator()" class="w-full mt-4 p-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                    Reset Calculator
                </button>
                <button id="logout-button" onclick="logout()" class="w-full mt-4 p-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 hidden">
                    Logout
                </button>
            </div>
        </div>
        
        <!-- Price Plan Breakdown -->
        <div class="deal-card bg-white rounded-xl overflow-hidden self-start">
             <div class="p-6 bg-gray-800 text-white text-center">
                <h1 id="breakdown-title" class="text-2xl font-bold">Monthly Plan Cost</h1>
                <p class="font-semibold mt-1">Month 2 & Beyond with AutoPay</p>
            </div>
            <div id="price-breakdown" class="p-6 space-y-4">
                <!-- Breakdown content will be generated here -->
            </div>
        </div>

    </div>

    <script>
        // Data for different phone promotions based on the provided PDF
        const dealData = {
            'iphone-13': { name: 'Apple iPhone 13 128GB', retailPrice: 529.00, promoPrice: 0.00, portOnlyPrice: 0.00, veriffOnlyPrice: 99.99, promoMonths: 3 },
            'iphone-13-cpo': { name: 'Apple iPhone 13 CPO 128GB', retailPrice: 349.99, promoPrice: 0.00, portOnlyPrice: 0.00, veriffOnlyPrice: 99.99, promoMonths: 2 },
            'iphone-14': { name: 'Apple iPhone 14 128GB', retailPrice: 629.00, promoPrice: 99.99, portOnlyPrice: 529.99, veriffOnlyPrice: 199.99, promoMonths: 3, requiredPlan: 40 },
            'iphone-14-plus': { name: 'Apple iPhone 14 Plus 128GB', retailPrice: 729.00, promoPrice: 199.99, portOnlyPrice: 499.99, veriffOnlyPrice: 199.99, noHasslePrice: 499.99, promoMonths: 1, requiredPlan: 40 },
            'iphone-15': { name: 'Apple iPhone 15 128GB', retailPrice: 729.00, promoPrice: 479.99, portOnlyPrice: 679.99, veriffOnlyPrice: 479.99, promoMonths: 1 },
            'iphone-16e': { name: 'Apple iPhone 16e 128GB', retailPrice: 599.99, promoPrice: 299.99, portOnlyPrice: 599.99, veriffOnlyPrice: 399.99, noHasslePrice: 599.99, promoMonths: 2 },
            'samsung-a15': { name: 'Samsung Galaxy A15 5G', retailPrice: 79.99, promoPrice: 0.00, portOnlyPrice: 59.99, veriffOnlyPrice: 0.00, promoMonths: 1 },
            'samsung-a16': { name: 'Samsung Galaxy A16 (5G)', retailPrice: 129.00, promoPrice: 0.00, portOnlyPrice: 0.00, veriffOnlyPrice: 0.00, noHasslePrice: 0.00, promoMonths: 1 },
            'samsung-a25': { name: 'Samsung Galaxy A25 5G', retailPrice: 199.99, promoPrice: 14.99, portOnlyPrice: 49.99, veriffOnlyPrice: 14.99, promoMonths: 1 },
            'samsung-a26': { name: 'Samsung Galaxy A26 5G', retailPrice: 199.99, promoPrice: 0.00, portOnlyPrice: 199.99, veriffOnlyPrice: 49.99, noHasslePrice: 149.99, promoMonths: 1 },
            'samsung-a36': { name: 'Samsung Galaxy A36 (5G)', retailPrice: 279.99, promoPrice: 0.00, portOnlyPrice: 199.99, veriffOnlyPrice: 99.99, promoMonths: 1 },
            'samsung-s24fe': { name: 'Samsung Galaxy S24FE (5G)', retailPrice: 699.99, promoPrice: 199.99, portOnlyPrice: 699.99, veriffOnlyPrice: 299.99, promoMonths: 2 },
            'moto-g-5g-2025': { name: 'Motorola Moto G 5G 2025', retailPrice: 79.99, promoPrice: 0.00, portOnlyPrice: 0.00, veriffOnlyPrice: 0.00, noHasslePrice: 0.00, promoMonths: 1 },
            'moto-g-stylus-5g-2024': { name: 'Moto G Stylus 5G 2024', retailPrice: 249.99, promoPrice: 0.00, portOnlyPrice: 49.99, veriffOnlyPrice: 24.99, promoMonths: 1, requiredPlan: 40 },
            'moto-g-stylus-5g-2025': { name: 'Moto G Stylus 5G 2025', retailPrice: 199.00, promoPrice: 0.00, portOnlyPrice: 149.99, veriffOnlyPrice: 49.99, promoMonths: 1, requiredPlan: 40 },
            'moto-edge-2024': { name: 'Motorola Edge 2024', retailPrice: 259.99, promoPrice: 0.00, portOnlyPrice: 149.99, veriffOnlyPrice: 49.99, promoMonths: 1 },
            'moto-edge-2025': { name: 'Motorola Edge 2025', retailPrice: 259.99, promoPrice: 0.00, portOnlyPrice: 149.99, veriffOnlyPrice: 49.99, promoMonths: 1 },
            'moto-razr-2025': { name: 'Motorola Razr 2025', retailPrice: 599.99, promoPrice: 199.99, portOnlyPrice: 599.99, veriffOnlyPrice: 299.99, promoMonths: 2 },
            'moto-g-power-5g-2024': { name: 'Moto G Power 5G 2024', retailPrice: 199.00, promoPrice: 0.00, portOnlyPrice: 0.00, veriffOnlyPrice: 0.00, promoMonths: 1 },
            'moto-g-power-5g-2025': { name: 'Moto G Power 5G 2025', retailPrice: 149.99, promoPrice: 0.00, portOnlyPrice: 49.99, veriffOnlyPrice: 0.00, promoMonths: 1 },
            'tcl-50xe': { name: 'TCL 50XE 5G', retailPrice: 79.99, promoPrice: 0.00, portOnlyPrice: 79.99, veriffOnlyPrice: 14.99, promoMonths: 1 },
            'tcl-50xl-nxtpaper': { name: 'TCL 50XL NXTPAPER 5G', retailPrice: 99.99, promoPrice: 0.00, portOnlyPrice: 49.99, veriffOnlyPrice: 14.99, promoMonths: 1 }
        };

        const tabletData = {
            'none': { name: 'None', msrp: 0, serviceCost: 0, upfrontMonths: 0 },
            'samsung-a9-plus': { name: 'Samsung A9+', msrp: 239.99, serviceCost: 20, upfrontMonths: 6 },
            'tcl-tab-10': { name: 'TCL Tab 10 NXTPAPER 5G', msrp: 219.99, serviceCost: 20, upfrontMonths: 3 }
        };
        
        const planBreakdownData = {
            '40': [40, 80, 100, 100, 115],
            '50': [55, 85, 110, 110, 125],
            '60': [65, 95, 120, 120, 135]
        };
        
        // --- Login Logic ---
        document.getElementById('login-form').addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent page refresh
            const passcode = document.getElementById('passcode').value;
            const errorElement = document.getElementById('login-error');

            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ passcode })
                });

                if (response.ok) {
                    sessionStorage.setItem('userPasscode', passcode); // Store passcode for logout
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('calculator-container').classList.remove('hidden');
                    document.getElementById('calculator-container').classList.add('grid');
                    document.getElementById('logout-button').classList.remove('hidden');
                    initializeApp();
                } else {
                    const data = await response.json();
                    errorElement.textContent = data.message || 'Invalid Passcode.';
                    errorElement.classList.remove('hidden');
                }
            } catch (error) {
                errorElement.textContent = 'An error occurred. Please try again.';
                errorElement.classList.remove('hidden');
            }
        });

        // --- Logout Logic ---
        document.getElementById('logout-button').addEventListener('click', async () => {
            const passcode = sessionStorage.getItem('userPasscode');
            if (passcode) {
                try {
                    await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ passcode })
                    });
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            }
            sessionStorage.removeItem('userPasscode');
            location.reload(); // Reload the page to show the login screen
        });


        // Main function to update the entire calculator UI and totals
        function updateCalculator() {
            // --- Read all user inputs ---
            const upgradeType = document.getElementById('upgrade-type-select').value;
            const rewardsAmount = parseInt(document.getElementById('rewards-select').value) || 0;
            const basePlanPrice = parseInt(document.getElementById('plan-select').value) || 0;
            const byodLines = parseInt(document.getElementById('byod-lines').value) || 0;
            const newDeviceLines = parseInt(document.getElementById('new-device-lines').value) || 0;
            const upgradeLines = parseInt(document.getElementById('upgrade-device-lines').value) || 0;
            const totalLines = byodLines + newDeviceLines;
            
            const idVerified = document.getElementById('id-verified').checked;
            const portIn = document.getElementById('port-in').checked;
            const homeInternetCheckbox = document.getElementById('home-internet');
            const homeInternet = homeInternetCheckbox.checked;
            const dedicatedHotspotCheckbox = document.getElementById('dedicated-hotspot');
            const dedicatedHotspot = dedicatedHotspotCheckbox.checked;
            const hotspotPlanCost = parseInt(document.getElementById('hotspot-plan-select').value);
            const selectedTabletKey = document.getElementById('tablet-select').value;
            const byotTabletLines = parseInt(document.getElementById('byot-tablet-lines').value) || 0;
            const currentTablet = tabletData[selectedTabletKey];
            const taxRateInput = document.getElementById('tax-rate-input');
            const taxRate = parseFloat(taxRateInput.value) / 100 || 0;
            const portedLines = parseInt(document.getElementById('ported-lines').value) || 0;
            const byodPorts = parseInt(document.getElementById('byod-ports-select').value) || 0;
            const redHotTicket = document.getElementById('red-hot-ticket').checked;
            const accessoryBundles = parseInt(document.getElementById('accessory-bundles').value) || 0;
            const currentLines = parseInt(document.getElementById('current-lines-select').value) || 0;

            // --- Get all DOM elements ---
            const simCardContainer = document.getElementById('sim-card-container');
            const simCardCheckbox = document.getElementById('sim-card-fee');
            const simCardLabel = document.getElementById('sim-card-label');
            const simCardAmountSpan = document.getElementById('sim-card-amount');
            const hotspotPlanContainer = document.getElementById('hotspot-plan-container');
            const promoBox = document.getElementById('promo-box');
            const promoBoxText = document.getElementById('promo-box-text');
            const portedLinesContainer = document.getElementById('ported-lines-container');
            const byodPortsContainer = document.getElementById('byod-ports-container');
            const rewardsContainer = document.getElementById('rewards-container');
            const rewardsCreditContainer = document.getElementById('rewards-credit-container');
            const rewardsCreditCheckbox = document.getElementById('rewards-credit');
            const byotServiceContainer = document.getElementById('byot-service-container');
            const byotServiceCheckbox = document.getElementById('byot-service');
            const tabletDeviceCostContainer = document.getElementById('tablet-device-cost-container'); 
            const tabletDeviceCostCheckbox = document.getElementById('tablet-device-cost'); 
            const planSelectLabel = document.getElementById('plan-select-label');
            const addALineControls = document.getElementById('add-a-line-controls');
            const currentLinesSelect = document.getElementById('current-lines-select');
            const billingCycleContainer = document.getElementById('billing-cycle-container');
            const billingCycleDaysInput = document.getElementById('billing-cycle-days');


            // --- UI Visibility Logic ---
            if (portIn) {
                portedLinesContainer.classList.remove('hidden');
                if(byodLines > 0 && newDeviceLines > 0) {
                    byodPortsContainer.classList.remove('hidden');
                } else {
                    byodPortsContainer.classList.add('hidden');
                }
            } else {
                portedLinesContainer.classList.add('hidden');
                byodPortsContainer.classList.add('hidden');
                document.getElementById('ported-lines').value = '0';
                document.getElementById('byod-ports-select').value = '0';
            }

            if (upgradeType === 'upgrade-with-rewards') {
                rewardsContainer.classList.remove('hidden');
            } else {
                rewardsContainer.classList.add('hidden');
                document.getElementById('rewards-select').value = '0';
            }

            if (upgradeType === 'add-a-line') {
                planSelectLabel.textContent = 'Select Current Plan:';
                addALineControls.classList.remove('hidden');
                if (parseInt(currentLinesSelect.value) > 0 || byotTabletLines > 0 || selectedTabletKey !== 'none') {
                    billingCycleContainer.classList.remove('hidden');
                } else {
                    billingCycleContainer.classList.add('hidden');
                }
            } else {
                planSelectLabel.textContent = 'Select Plan:';
                addALineControls.classList.add('hidden');
                billingCycleContainer.classList.add('hidden');
            }


            // --- Determine Device Costs & Promotions ---
            let totalDeviceCost = 0;
            let totalRetailForTax = 0;
            let newDeviceKeys = [];
            let upgradeDeviceKeys = [];
            let promoMessages = [];

            if (newDeviceLines > 0) {
                for (let i = 1; i <= newDeviceLines; i++) {
                    const selector = document.getElementById(`device-select-${i}`);
                    newDeviceKeys.push(selector.value);
                }
            }
            if (upgradeLines > 0) {
                for (let i = 1; i <= upgradeLines; i++) {
                    const selector = document.getElementById(`upgrade-device-select-${i}`);
                    upgradeDeviceKeys.push(selector.value);
                }
            }

            // [NEW] 4 Promo Device Limit
            if (newDeviceLines > 4) {
                promoMessages.push("<b>Notice:</b> Accounts are limited to 4 promotional devices.");
            }
            
            const selectedDeviceKeys = [...newDeviceKeys, ...upgradeDeviceKeys];
            const hasIphone13 = selectedDeviceKeys.includes('iphone-13') || selectedDeviceKeys.includes('iphone-13-cpo');
            const hasIphone14 = selectedDeviceKeys.includes('iphone-14');
            const hasIphone14Plus = selectedDeviceKeys.includes('iphone-14-plus');
            const hasMotoStylus = selectedDeviceKeys.some(key => key.includes('moto-g-stylus'));

            const isUpgradeOnly = upgradeType === 'upgrade-only' || upgradeType === 'upgrade-with-rewards';
            const isAddingALine = upgradeType === 'add-a-line';

            // Calculate cost for new devices (promotional)
            let newDevicePortsAvailable = portedLines - byodPorts;
            const motoGStylus2024Count = newDeviceKeys.filter(k => k === 'moto-g-stylus-5g-2024').length;
            const isMotoGStylusPromoActive = motoGStylus2024Count > 0 && motoGStylus2024Count === newDeviceLines && newDeviceLines <= 4 && idVerified && portedLines >= 1;

            if (isMotoGStylusPromoActive) {
                for (let i = 0; i < newDeviceLines; i++) {
                    const currentDeal = dealData['moto-g-stylus-5g-2024'];
                    totalRetailForTax += currentDeal.retailPrice;
                }
            } else {
                newDeviceKeys.forEach(selectedKey => {
                    const currentDeal = dealData[selectedKey];
                    totalRetailForTax += currentDeal.retailPrice;

                    let meetsPlanRequirement = true;
                    if (currentDeal.requiredPlan && basePlanPrice < currentDeal.requiredPlan) {
                        meetsPlanRequirement = false;
                        promoMessages.push(`<b>${currentDeal.name}</b> promo requires the $${currentDeal.requiredPlan} plan or higher.`);
                    }

                    if (meetsPlanRequirement) {
                        if (idVerified && newDevicePortsAvailable > 0) {
                            totalDeviceCost += currentDeal.promoPrice;
                            newDevicePortsAvailable--;
                        } else if (newDevicePortsAvailable > 0) {
                             totalDeviceCost += currentDeal.portOnlyPrice;
                            newDevicePortsAvailable--;
                        } else if (idVerified) {
                            totalDeviceCost += currentDeal.veriffOnlyPrice;
                        } else {
                            totalDeviceCost += currentDeal.noHasslePrice !== undefined ? currentDeal.noHasslePrice : currentDeal.retailPrice;
                        }
                    } else {
                        totalDeviceCost += currentDeal.noHasslePrice !== undefined ? currentDeal.noHasslePrice : currentDeal.retailPrice;
                    }
                });
            }

            upgradeDeviceKeys.forEach(selectedKey => {
                const currentDeal = dealData[selectedKey];
                totalRetailForTax += currentDeal.retailPrice;
                totalDeviceCost += currentDeal.retailPrice;
            });
            
            
            document.getElementById('device-cost-container').style.display = totalDeviceCost > 0 ? 'block' : 'none';
            document.getElementById('device-cost').checked = totalDeviceCost > 0;
            document.getElementById('device-cost').dataset.amount = totalDeviceCost.toFixed(2);
            document.getElementById('device-cost-label').textContent = `Mobile Device Cost (${newDeviceLines + upgradeLines} dev)`;
            document.getElementById('device-cost-amount').textContent = `$${totalDeviceCost.toFixed(2)}`;
            
            // --- Calculate Service Cost ---
            let finalServiceCost = 0;
            let serviceLabelText = 'First Month Mobile Service';

            if (isAddingALine) {
                const daysIntoCycle = parseInt(billingCycleDaysInput.value) || 0;
                const newLines = totalLines;

                if (basePlanPrice > 0 && currentLines > 0 && newLines > 0 && daysIntoCycle >= 0 && daysIntoCycle <= 30) {
                    const planPrices = planBreakdownData[basePlanPrice.toString()];
                    if (planPrices && planPrices[currentLines - 1] !== undefined && planPrices[currentLines + newLines - 1] !== undefined) {
                        const originalCost = planPrices[currentLines - 1];
                        const newTotalCost = planPrices[currentLines + newLines - 1];
                        const addedLinesMonthlyCost = newTotalCost - originalCost;
                        const proratedCost = (addedLinesMonthlyCost / 30) * (30 - daysIntoCycle);
                        finalServiceCost = proratedCost;
                        serviceLabelText = `Prorated Service Cost (${30 - daysIntoCycle} days)`;
                    }
                }
            } else {
                let baseServiceCost = 0;
               
                if (totalLines > 0 && basePlanPrice > 0) {
                    const planPrices = planBreakdownData[basePlanPrice.toString()];
                    baseServiceCost = planPrices[totalLines - 1] || 0;
                    
                    // Apply autopay discount for single lines on eligible plans for the first month
                    if (totalLines === 1 && (basePlanPrice === 50 || basePlanPrice === 60)) {
                        baseServiceCost -= 5;
                    }

                    if (portIn && byodPorts > 0) {
                        const singleLineBasePrice = planBreakdownData[basePlanPrice.toString()][0];
                        const discountPerByodPort = singleLineBasePrice * 0.5;
                        baseServiceCost -= discountPerByodPort;
                    }
                }
                
                let serviceDiscount = 0;
                const canUseRedHotTicket = portedLines > 0 && !isUpgradeOnly && !hasIphone13 && !hasIphone14 && !hasIphone14Plus && !hasMotoStylus;

                if (redHotTicket && canUseRedHotTicket) {
                   const planPrices = planBreakdownData[basePlanPrice.toString()];
                   if(planPrices && portedLines > 0) {
                        let costOfPortedLines = planPrices[portedLines - 1];
                        const singleLineCost = planPrices[0];
                        const byodPortsAmongTotalPorts = Math.min(byodPorts, portedLines);
                        
                        if (byodPortsAmongTotalPorts > 0) {
                           costOfPortedLines -= (singleLineCost * 0.5);
                        }
                       
                        serviceDiscount = Math.min(costOfPortedLines, 120);
                   }
                }
                
                finalServiceCost = baseServiceCost - serviceDiscount;
                serviceLabelText = `First Month Mobile Service (${totalLines} line${totalLines !== 1 ? 's' : ''})`;
            }
            
            document.getElementById('service-container').style.display = (totalLines > 0 && !isAddingALine) || (isAddingALine && finalServiceCost > 0) ? 'block' : 'none';
            document.getElementById('service').checked = finalServiceCost > 0;
            document.getElementById('service').dataset.amount = finalServiceCost.toFixed(2);
            document.getElementById('service-label').textContent = serviceLabelText;
            document.getElementById('service-amount').textContent = `$${finalServiceCost.toFixed(2)}`;

            // --- Handle Multi-Month Service Promo ---
            const promoMonthsContainer = document.getElementById('promo-months-container');
            const promoMonthsCheckbox = document.getElementById('promo-months');
            let promoMonthsCost = 0;
            let promoMonthsRequired = false;
            let promoMonthsCount = 0;

            const promoDeviceKey = selectedDeviceKeys.find(key => dealData[key] && dealData[key].promoMonths > 1);
            const isNewSingleLineAccount = upgradeType === 'new-account' && totalLines === 1;
            const hasExistingLines = (isAddingALine || upgradeType === 'upgrade-add-line') && currentLines >= 1;
            
            if (basePlanPrice > 0 && isNewSingleLineAccount && promoDeviceKey) {
                const deal = dealData[promoDeviceKey];
                let isPromoApplicable = true;

                if (promoDeviceKey === 'moto-razr-2025' && !(basePlanPrice === 50 || basePlanPrice === 60)) {
                    isPromoApplicable = false;
                }
                
                if (isPromoApplicable) {
                    promoMonthsRequired = true;
                    promoMonthsCount = deal.promoMonths - 1;
                    promoMonthsCost = basePlanPrice * promoMonthsCount;
                    promoMessages.push(`<b>${deal.name}</b> requires paying for ${deal.promoMonths} months of service upfront for a single line.`);
                }

            } else if (promoDeviceKey && (totalLines > 1 || hasExistingLines)) {
                 if (!promoMessages.some(m => m.includes("waived"))) {
                    promoMessages.push(`The upfront promotional month payment is waived for multi-line or existing accounts.`);
                 }
            }

            promoMonthsContainer.style.display = promoMonthsRequired ? 'block' : 'none';
            promoMonthsCheckbox.checked = promoMonthsRequired;
            promoMonthsCheckbox.disabled = promoMonthsRequired;
            promoMonthsCheckbox.dataset.amount = promoMonthsCost.toFixed(2);
            document.getElementById('promo-months-label').textContent = `Promotional Months (Month 2${promoMonthsCount > 1 ? ` - ${promoMonthsCount + 1}` : ''})`;
            document.getElementById('promo-months-amount').textContent = `$${promoMonthsCost.toFixed(2)}`;
            
            // --- Handle Red Hot Ticket & Promo Box ---
            const redHotTicketContainer = document.getElementById('red-hot-ticket-container');
            const redHotTicketCheckbox = document.getElementById('red-hot-ticket');
            
            const canUseRedHotTicket = upgradeType !== 'add-a-line' && portedLines > 0 && !isUpgradeOnly && !hasIphone13 && !hasIphone14 && !hasIphone14Plus && !hasMotoStylus;
            const qualifiesForByodDiscount = portIn && byodPorts > 0;

            if (canUseRedHotTicket) {
                redHotTicketContainer.style.display = 'block';
                redHotTicketCheckbox.disabled = false;
                let rhtMessage = "Congratulations! You qualify for the Red Hot Ticket!";
                if (qualifiesForByodDiscount) {
                    rhtMessage = "Congratulations! You qualify for 50% off the first BYOD line and the Red Hot Ticket.";
                }
                if (!promoMessages.some(m => m.includes("Red Hot Ticket"))) {
                     promoMessages.push(rhtMessage);
                }
            } else {
                redHotTicketContainer.style.display = 'none';
                redHotTicketCheckbox.checked = false;
                redHotTicketCheckbox.disabled = true;
            }

            if (qualifiesForByodDiscount && !canUseRedHotTicket) {
                if (!promoMessages.some(m => m.includes("50% off"))) { // Avoid duplicate message
                    promoMessages.push("50% off first BYOD line for Port-in.");
                }
            }
            
            // Display promo messages
            if (promoMessages.length > 0) {
                promoBox.style.display = 'block';
                promoBoxText.innerHTML = [...new Set(promoMessages)].join('<br><br>'); // Use Set to remove duplicates
            } else {
                promoBox.style.display = 'none';
            }

            // --- Handle Home Internet, Hotspot & Tablets ---
            const routerCostContainer = document.getElementById('router-cost-container');
            const routerCostCheckbox = document.getElementById('router-cost');
            const internetLabel = document.getElementById('internet-label');
            const internetAmount = document.getElementById('internet-amount');
            
            if (homeInternet) {
                homeInternetCheckbox.dataset.amount = '49.99';
                internetAmount.textContent = '$49.99';

                if (totalLines > 0 || upgradeLines > 0 || currentLines > 0) {
                    internetLabel.textContent = 'Home Internet Promo (Router + 3mo Service)';
                    routerCostContainer.style.display = 'none';
                    routerCostCheckbox.checked = false;
                    routerCostCheckbox.dataset.amount = '0';
                } else {
                    internetLabel.textContent = 'Home Internet Service (3 Months)';
                    routerCostContainer.style.display = 'block';
                    routerCostCheckbox.checked = true;
                    routerCostCheckbox.dataset.amount = '49.99';
                    document.getElementById('router-cost-amount').textContent = `$49.99`;
                }
            } else {
                internetLabel.textContent = 'Home Internet Service';
                homeInternetCheckbox.dataset.amount = '49.99';
                routerCostContainer.style.display = 'none';
                routerCostCheckbox.checked = false;
                routerCostCheckbox.dataset.amount = '0';
            }


            hotspotPlanContainer.style.display = dedicatedHotspot ? 'block' : 'none';
            const finalHotspotPlanCost = dedicatedHotspot ? hotspotPlanCost : 0;
            
            if (selectedTabletKey !== 'none') {
                const isTabletOnlyNewAccount = (upgradeType === 'new-account' || upgradeType === '') && totalLines === 0 && byotTabletLines === 0 && newDeviceLines === 0 && upgradeLines === 0;
                let tabletServiceCost;
                let tabletUpfrontMonths;
                let tabletDeviceCost = 0;
                let tabletServiceLabel = `${currentTablet.name} Service`;

                if (isTabletOnlyNewAccount) {
                    tabletServiceCost = 60;
                    tabletUpfrontMonths = 1;
                    tabletDeviceCost = currentTablet.msrp;
                    if (!promoMessages.some(m => m.includes("Tablet-only"))) {
                        promoMessages.push("<b>Notice:</b> Tablet-only accounts have a $60/mo service cost and do not qualify for device promotions.");
                    }
                } else if (isAddingALine) {
                    const daysIntoCycle = parseInt(billingCycleDaysInput.value) || 0;
                    const remainingDays = 30 - daysIntoCycle;
                    const proratedFirstMonthCost = (currentTablet.serviceCost / 30) * remainingDays;
                    const remainingFullMonths = currentTablet.upfrontMonths - 1;
                    const remainingMonthsCost = remainingFullMonths > 0 ? currentTablet.serviceCost * remainingFullMonths : 0;

                    tabletServiceCost = proratedFirstMonthCost + remainingMonthsCost;
                    tabletUpfrontMonths = 0; // It's a custom calculation now
                    tabletDeviceCost = 0; 
                    tabletServiceLabel = `${currentTablet.name} (Prorated + ${remainingFullMonths} mo)`;
                }
                else {
                    tabletServiceCost = currentTablet.serviceCost;
                    tabletUpfrontMonths = currentTablet.upfrontMonths;
                    tabletDeviceCost = 0; // Device is free (promo) with a voice line
                }

                const upfrontServiceCost = tabletUpfrontMonths > 0 ? tabletServiceCost * tabletUpfrontMonths : tabletServiceCost;
                
                document.getElementById('tablet-service-container').style.display = 'block';
                document.getElementById('tablet-service').checked = true;
                document.getElementById('tablet-service').dataset.amount = upfrontServiceCost.toFixed(2);
                document.getElementById('tablet-service-label').textContent = tabletUpfrontMonths > 0 ? `${currentTablet.name} Service (${tabletUpfrontMonths} month${tabletUpfrontMonths !== 1 ? 's' : ''})` : tabletServiceLabel;
                document.getElementById('tablet-service-amount').textContent = `$${upfrontServiceCost.toFixed(2)}`;
                
                if (tabletDeviceCost > 0) {
                    tabletDeviceCostContainer.style.display = 'block';
                    tabletDeviceCostCheckbox.checked = true;
                    tabletDeviceCostCheckbox.dataset.amount = tabletDeviceCost.toFixed(2);
                    document.getElementById('tablet-device-cost-label').textContent = `${currentTablet.name} Device`;
                    document.getElementById('tablet-device-cost-amount').textContent = `$${tabletDeviceCost.toFixed(2)}`;
                } else {
                    tabletDeviceCostContainer.style.display = 'none';
                    tabletDeviceCostCheckbox.checked = false;
                }
                totalRetailForTax += currentTablet.msrp;

            } else {
                document.getElementById('tablet-service-container').style.display = 'none';
                document.getElementById('tablet-service').checked = false;
                tabletDeviceCostContainer.style.display = 'none';
                tabletDeviceCostCheckbox.checked = false;
            }
            
            const byotServiceCost = byotTabletLines * 20;
            byotServiceContainer.style.display = byotServiceCost > 0 ? 'block' : 'none';
            byotServiceCheckbox.checked = byotServiceCost > 0;
            byotServiceCheckbox.dataset.amount = byotServiceCost.toFixed(2);
            document.getElementById('byot-service-label').textContent = `BYOT Service (${byotTabletLines} line${byotTabletLines !== 1 ? 's' : ''})`;
            document.getElementById('byot-service-amount').textContent = `$${byotServiceCost.toFixed(2)}`;


            // --- Update Dropdowns ---
            const totalDevicesInTransaction = byodLines + newDeviceLines + upgradeLines + byotTabletLines;
            ['protect-lines', 'ported-lines', 'accessory-bundles'].forEach(id => {
                const select = document.getElementById(id);
                const currentVal = parseInt(select.value) || 0;
                select.innerHTML = '';
                for (let i = 0; i <= totalDevicesInTransaction; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    select.appendChild(option);
                }
                select.value = Math.min(currentVal, totalDevicesInTransaction);
            });
             const byodPortsSelect = document.getElementById('byod-ports-select');
             const maxByodPorts = Math.min(byodLines, portedLines);
             const currentByodPortsVal = parseInt(byodPortsSelect.value) || 0;
             byodPortsSelect.innerHTML = '';
             for (let i = 0; i <= maxByodPorts; i++) {
                 const option = document.createElement('option');
                 option.value = i;
                 option.textContent = i;
                 byodPortsSelect.appendChild(option);
             }
             byodPortsSelect.value = Math.min(currentByodPortsVal, maxByodPorts);


            // --- Update Fees & Protect ---
            const protectLinesCount = parseInt(document.getElementById('protect-lines').value) || 0;
            const protectCost = 5 * protectLinesCount;
            document.getElementById('total-protect-container').style.display = totalDevicesInTransaction > 0 ? 'block' : 'none';
            document.getElementById('total-protect').checked = protectCost > 0;
            document.getElementById('total-protect').dataset.amount = protectCost.toFixed(2);
            document.getElementById('protect-label').textContent = `Total Protect (${protectLinesCount} line${protectLinesCount !== 1 ? 's' : ''})`;
            document.getElementById('protect-amount').textContent = `$${protectCost.toFixed(2)}`;
            
            const accessoryCost = 75 * (parseInt(document.getElementById('accessory-bundles').value) || 0);
            document.getElementById('accessory-bundle-container').style.display = accessoryCost > 0 ? 'block' : 'none';
            document.getElementById('accessory-bundle-cost').checked = accessoryCost > 0;
            document.getElementById('accessory-bundle-cost').dataset.amount = accessoryCost.toFixed(2);
            document.getElementById('accessory-bundle-label').textContent = `Accessory Bundle (${document.getElementById('accessory-bundles').value} bundle${(parseInt(document.getElementById('accessory-bundles').value) || 0) !== 1 ? 's' : ''})`;
            document.getElementById('accessory-bundle-amount').textContent = `$${accessoryCost.toFixed(2)}`;

            let accessFee = 0;
            if (!isUpgradeOnly && upgradeType !== 'add-a-line') {
                accessFee = Math.min(totalLines, 2) * 25;
            } else if (upgradeType === 'add-a-line') {
                accessFee = Math.min(totalLines, 2) * 25; // Access fee still applies for AAL
            }
            document.getElementById('access-fee-container').style.display = (totalLines > 0 && !isUpgradeOnly) ? 'block' : 'none';
            document.getElementById('access').checked = accessFee > 0;
            document.getElementById('access').dataset.amount = accessFee.toFixed(2);
            document.getElementById('access-label').textContent = `Access Fee (Mobile) (${totalLines} line${totalLines !== 1 ? 's' : ''})`;
            document.getElementById('access-amount').textContent = `$${accessFee.toFixed(2)}`;
            
            const simCardFee = (byodLines + byotTabletLines) * 3;
            const totalSims = byodLines + byotTabletLines;
            simCardContainer.style.display = totalSims > 0 ? 'block' : 'none';
            simCardCheckbox.checked = totalSims > 0;
            simCardCheckbox.dataset.amount = simCardFee.toFixed(2);
            simCardLabel.textContent = `Sim Card (${totalSims} sim${totalSims !== 1 ? 's' : ''})`;
            simCardAmountSpan.textContent = `$${simCardFee.toFixed(2)}`;

            // --- Handle Rewards Credit ---
            if (upgradeType === 'upgrade-with-rewards' && rewardsAmount > 0) {
                rewardsCreditContainer.classList.remove('hidden');
                rewardsCreditCheckbox.checked = true;
                rewardsCreditCheckbox.dataset.amount = -rewardsAmount; // Negative amount for deduction
                document.getElementById('rewards-credit-amount').textContent = `-$${rewardsAmount.toFixed(2)}`;
            } else {
                rewardsCreditContainer.classList.add('hidden');
                rewardsCreditCheckbox.checked = false;
            }

            // --- Sales Tax Calculation ---
            const homeRouterMsrp = 99.00;
            const taxableHomeRouterAmount = homeInternet ? homeRouterMsrp : 0;
            const taxableHotspotAmount = dedicatedHotspot ? 49.99 : 0;
            const taxableAccessoryAmount = accessoryCost;
            const taxableAccessFee = (totalLines > 0 && document.getElementById('access').checked) ? accessFee : 0;

            const totalTaxableDeviceAmount = totalRetailForTax + taxableHomeRouterAmount + taxableAccessoryAmount + taxableHotspotAmount;
            const totalTax = (totalTaxableDeviceAmount * taxRate) + (taxableAccessFee * taxRate);
            
            document.getElementById('sales-tax').dataset.amount = totalTax.toFixed(2);
            document.getElementById('tax-amount').textContent = `$${totalTax.toFixed(2)}`;
            const isTaxable = totalTaxableDeviceAmount > 0 || taxableAccessFee > 0;
            document.getElementById('sales-tax').disabled = !isTaxable;
            document.getElementById('tax-rate-input').disabled = !isTaxable;
            document.getElementById('sales-tax').checked = isTaxable;

            // --- Calculate Final Total ---
            let total = 0;
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    total += parseFloat(checkbox.dataset.amount) || 0;
                }
            });
            
            total += finalHotspotPlanCost;

            document.getElementById('total-due').textContent = `$${total.toFixed(2)}`;
            
            updatePriceBreakdown();
        }

        function updatePriceBreakdown() {
            const breakdownContainer = document.getElementById('price-breakdown');
            const selectedPlan = document.getElementById('plan-select').value;
            const byodLines = parseInt(document.getElementById('byod-lines').value) || 0;
            const byodPorts = parseInt(document.getElementById('byod-ports-select').value) || 0;
            const portIn = document.getElementById('port-in').checked;
            const breakdownTitle = document.getElementById('breakdown-title');
            
            // Get addon values
            const protectLinesCount = parseInt(document.getElementById('protect-lines').value) || 0;
            const dedicatedHotspot = document.getElementById('dedicated-hotspot').checked;
            const hotspotPlanCost = dedicatedHotspot ? parseInt(document.getElementById('hotspot-plan-select').value) : 0;
            const totalProtectCost = protectLinesCount * 5;
            const byotTabletLines = parseInt(document.getElementById('byot-tablet-lines').value) || 0;
            const byotMonthlyCost = byotTabletLines * 20;

            const prices = planBreakdownData[selectedPlan];
            
            breakdownContainer.innerHTML = '';
            
            // Handle case where no plan is selected
            if (!prices) {
                breakdownTitle.textContent = 'Monthly Plan Cost';
                const div = document.createElement('div');
                div.className = 'text-center text-gray-500';
                div.textContent = 'Select a plan to see monthly costs.';
                breakdownContainer.appendChild(div);
                return;
            }

            let discount = 0;
            const qualifiesForByodDiscount = portIn && byodPorts > 0;

            if (qualifiesForByodDiscount) {
                const singleLineBasePrice = planBreakdownData[selectedPlan][0];
                discount = singleLineBasePrice * 0.5;
                breakdownTitle.textContent = 'Monthly Cost (w/ BYOD Discount)';
            } else {
                breakdownTitle.textContent = 'Monthly Plan Cost';
            }

            prices.forEach((price, index) => {
                const lineCount = index + 1;
                let finalPrice = price; // Base price from new data object

                // Apply autopay discount ONLY for single line on eligible plans
                if (lineCount === 1 && (selectedPlan === '50' || selectedPlan === '60')) {
                    finalPrice -= 5;
                }
                
                // Apply BYOD discount if applicable
                if (qualifiesForByodDiscount && lineCount >= byodPorts) {
                     finalPrice -= discount;
                }

                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-gray-600';
                
                const spanLabel = document.createElement('span');
                spanLabel.textContent = `${lineCount} Line${lineCount > 1 ? 's' : ''}`;
                
                const priceContainer = document.createElement('div');
                priceContainer.className = 'flex items-baseline';

                const spanPrice = document.createElement('span');
                spanPrice.className = 'font-medium text-gray-900';
                spanPrice.textContent = `$${finalPrice.toFixed(2)}`;
                priceContainer.appendChild(spanPrice);
                
                if (qualifiesForByodDiscount && lineCount >= 1) {
                    let originalPrice = price;
                     if (lineCount === 1 && (selectedPlan === '50' || selectedPlan === '60')) {
                        originalPrice -= 5;
                    }
                    const originalPriceSpan = document.createElement('span');
                    originalPriceSpan.className = 'text-xs text-gray-400 line-through ml-2';
                    originalPriceSpan.textContent = `$${originalPrice.toFixed(2)}`;
                    priceContainer.appendChild(originalPriceSpan);
                }

                div.appendChild(spanLabel);
                div.appendChild(priceContainer);
                breakdownContainer.appendChild(div);
            });

            // Add a sub-breakdown for the addons
            if (totalProtectCost > 0 || hotspotPlanCost > 0 || byotMonthlyCost > 0) {
                const addonsContainer = document.createElement('div');
                addonsContainer.className = 'mt-4 pt-4 border-t border-dashed space-y-2';

                if (totalProtectCost > 0) {
                    const protectDiv = document.createElement('div');
                    protectDiv.className = 'flex justify-between items-center text-sm text-gray-500';
                    protectDiv.innerHTML = `<span>Total Protect (${protectLinesCount} lines)</span><span class="font-medium">+$${totalProtectCost.toFixed(2)}</span>`;
                    addonsContainer.appendChild(protectDiv);
                }
                
                if (byotMonthlyCost > 0) {
                    const byotDiv = document.createElement('div');
                    byotDiv.className = 'flex justify-between items-center text-sm text-gray-500';
                    byotDiv.innerHTML = `<span>BYOT Service (${byotTabletLines} lines)</span><span class="font-medium">+$${byotMonthlyCost.toFixed(2)}</span>`;
                    addonsContainer.appendChild(byotDiv);
                }

                if (hotspotPlanCost > 0) {
                    const hotspotDiv = document.createElement('div');
                    hotspotDiv.className = 'flex justify-between items-center text-sm text-gray-500';
                    hotspotDiv.innerHTML = `<span>Dedicated Hotspot Plan</span><span class="font-medium">+$${hotspotPlanCost.toFixed(2)}</span>`;
                    addonsContainer.appendChild(hotspotDiv);
                }
                
                breakdownContainer.appendChild(addonsContainer);
            }
        }
        
        function populateDropdown(selectElement, max) {
            const currentValue = parseInt(selectElement.value) || 0;
            selectElement.innerHTML = '';
            for (let i = 0; i <= max; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                selectElement.appendChild(option);
            }
            selectElement.value = Math.min(currentValue, max);
        }

        function updateLineDropdowns(changedInput) {
            const byodSelect = document.getElementById('byod-lines');
            const newDeviceSelect = document.getElementById('new-device-lines');
            const maxLines = 5;

            let byodCount = parseInt(byodSelect.value) || 0;
            let newDeviceCount = parseInt(newDeviceSelect.value) || 0;

            if (changedInput === 'byod') {
                populateDropdown(newDeviceSelect, maxLines - byodCount);
            } else if (changedInput === 'new') {
                populateDropdown(byodSelect, maxLines - newDeviceCount);
            }

            if (changedInput === 'new') {
                generateDeviceSelectors();
            } else {
                updateCalculator();
            }
        }


        function generateDeviceSelectors() {
            const container = document.getElementById('new-device-selectors');
            const newDeviceLines = parseInt(document.getElementById('new-device-lines').value) || 0;
            container.innerHTML = '';

            for (let i = 1; i <= newDeviceLines; i++) {
                const selectWrapper = document.createElement('div');
                const label = document.createElement('label');
                label.htmlFor = `device-select-${i}`;
                label.className = 'block text-sm font-medium text-gray-700 mb-1';
                label.textContent = `New Device for Line ${i}:`;
                
                const select = document.createElement('select');
                select.id = `device-select-${i}`;
                select.className = 'w-full p-2 border border-gray-300 rounded-md';
                select.onchange = updateCalculator;

                Object.keys(dealData).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = dealData[key].name;
                    select.appendChild(option);
                });
                
                selectWrapper.appendChild(label);
                selectWrapper.appendChild(select);
                container.appendChild(selectWrapper);
            }
            updateCalculator();
        }

        function generateUpgradeDeviceSelectors() {
            const container = document.getElementById('upgrade-device-selectors');
            const upgradeLines = parseInt(document.getElementById('upgrade-device-lines').value) || 0;
            container.innerHTML = '';

            for (let i = 1; i <= upgradeLines; i++) {
                const selectWrapper = document.createElement('div');
                const label = document.createElement('label');
                label.htmlFor = `upgrade-device-select-${i}`;
                label.className = 'block text-sm font-medium text-gray-700 mb-1';
                label.textContent = `Upgrade Device ${i}:`;
                
                const select = document.createElement('select');
                select.id = `upgrade-device-select-${i}`;
                select.className = 'w-full p-2 border border-gray-300 rounded-md';
                select.onchange = updateCalculator;

                Object.keys(dealData).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = dealData[key].name;
                    select.appendChild(option);
                });
                
                selectWrapper.appendChild(label);
                selectWrapper.appendChild(select);
                container.appendChild(selectWrapper);
            }
            updateCalculator();
        }

        function resetCalculator() {
            document.getElementById('plan-select').value = '';
            document.getElementById('upgrade-type-select').value = '';
            document.getElementById('rewards-select').value = '0';
            document.getElementById('byod-lines').value = '0';
            document.getElementById('new-device-lines').value = '0';
            document.getElementById('upgrade-device-lines').value = '0';
            document.getElementById('protect-lines').value = '0';
            document.getElementById('ported-lines').value = '0';
            document.getElementById('tablet-select').value = 'none';
            document.getElementById('byot-tablet-lines').value = '0';
            document.getElementById('current-lines-select').value = '0';
            document.getElementById('billing-cycle-days').value = '0';
            document.getElementById('id-verified').checked = false;
            document.getElementById('port-in').checked = false;
            document.getElementById('home-internet').checked = false;
            document.getElementById('dedicated-hotspot').checked = false;
            document.getElementById('tax-rate-input').value = '10.3';
            document.getElementById('accessory-bundles').value = '0';
            populateDropdown(document.getElementById('byod-lines'), 5);
            populateDropdown(document.getElementById('new-device-lines'), 5);
            generateUpgradeDeviceSelectors();
            updateLineDropdowns('new');
        }


        // --- Initial Load ---
        function initializeApp() {
            const tabletSelect = document.getElementById('tablet-select');
            Object.keys(tabletData).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = tabletData[key].name;
                tabletSelect.appendChild(option);
            });
            
            const byodSelect = document.getElementById('byod-lines');
            const newDeviceSelect = document.getElementById('new-device-lines');
            const upgradeDeviceSelect = document.getElementById('upgrade-device-lines');
            const byotTabletSelect = document.getElementById('byot-tablet-lines');
            const maxLines = 5;

            for (let i = 0; i <= maxLines; i++) { 
                const byodOption = document.createElement('option');
                byodOption.value = i;
                byodOption.textContent = i;
                byodSelect.appendChild(byodOption);

                const newDeviceOption = document.createElement('option');
                newDeviceOption.value = i;
                newDeviceOption.textContent = i;
                newDeviceSelect.appendChild(newDeviceOption);
                
                const upgradeDeviceOption = document.createElement('option');
                upgradeDeviceOption.value = i;
                upgradeDeviceOption.textContent = i;
                upgradeDeviceSelect.appendChild(upgradeDeviceOption);

                const byotTabletOption = document.createElement('option');
                byotTabletOption.value = i;
                byotTabletOption.textContent = i;
                byotTabletSelect.appendChild(byotTabletOption);
            }

            byodSelect.value = 0;
            newDeviceSelect.value = 0;
            upgradeDeviceSelect.value = 0;
            byotTabletSelect.value = 0;
            updateLineDropdowns('new');
        }

    </script>

</body>
</html>

